<link rel="import" href="../bower_components/polymer/polymer.html">

<script src="../bower_components/jsonld/js/jsonld.js"></script>

<polymer-element name="csv-row" extends="tr" attributes="item index keys context">
  <template>
    <td template repeat="{{ key in keys }}">
      <template if="{{ !expanded }}">
        <div>{{ item[key] }}</div>
      </template>

      <template repeat="{{ value in expanded[key] }}">
        <div>{{ value }}</div>
      </template>
    </td>
  </template>

  <script>
      Polymer({
        index: 0,

        // called when the item is changed
        contextChanged: function() {
            this.expand();
        },

        // expand property names to URLs, using the JSON-LD context
        expand: function() {
          if (!this.item) {
            return;
          }

          if (!this.context) {
            return;
          }

          // must attach the content to the item,
          // rather than passing it to jsonld.expand as an argument
          this.item['@context'] = this.context['@context'];

          jsonld.expand(this.item, function(err, expanded) {
            if (err) {
              console.error(err);
              return;
            }

            var item = expanded[0];

            if (this.index === 0) {
              this.keys = Object.keys(item);
            }

            Object.keys(item).forEach(function(key) {
              item[key] = item[key].map(this.convert);
            }.bind(this));

            this.expanded = item;
          }.bind(this));
        },

        // convert a string to a specific data type, if defined
        convert: function(item) {
          switch (item['@type']) {
            case 'http://www.w3.org/2001/XMLSchema#integer':
              return Number(item['@value']);

            case 'http://www.w3.org/2001/XMLSchema#dateTime':
              return new Date(item['@value']);

            default:
              return item['@value'];
          }
        }
      });
  </script>
</polymer-element>
